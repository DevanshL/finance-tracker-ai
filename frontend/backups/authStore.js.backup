import { create } from 'zustand';
import { persist } from 'zustand/middleware';
import { authAPI } from '../services/api';
import toast from 'react-hot-toast';

export const useAuthStore = create(
  persist(
    (set, get) => ({
      user: null,
      token: null,
      isLoading: false,
      isAuthenticated: false,
      error: null,

      register: async (name, email, password, passwordConfirm) => {
        set({ isLoading: true, error: null });
        try {
          const response = await authAPI.register(name, email, password, passwordConfirm);
          
          if (response.success && response.data?.token) {
            localStorage.setItem('token', response.data.token);
            localStorage.setItem('user', JSON.stringify(response.data.user));
            
            set({
              user: response.data.user,
              token: response.data.token,
              isAuthenticated: true,
              isLoading: false
            });

            toast.success('Registration successful!');
            return response.data;
          } else {
            throw new Error(response.message || 'Registration failed');
          }
        } catch (error) {
          const errorMessage = error.message || 'Registration failed. Please try again.';
          set({
            error: errorMessage,
            isLoading: false
          });
          toast.error(errorMessage);
          throw error;
        }
      },

      login: async (email, password) => {
        set({ isLoading: true, error: null });
        try {
          const response = await authAPI.login(email, password);
          
          if (response.success && response.data?.token) {
            localStorage.setItem('token', response.data.token);
            localStorage.setItem('user', JSON.stringify(response.data.user));
            
            set({
              user: response.data.user,
              token: response.data.token,
              isAuthenticated: true,
              isLoading: false,
              error: null
            });

            toast.success('Login successful!');
            return response.data;
          } else {
            throw new Error(response.message || 'Login failed');
          }
        } catch (error) {
          const errorMessage = error.message || 'Invalid email or password. Please try again.';
          set({
            error: errorMessage,
            isLoading: false
          });
          toast.error(errorMessage);
          throw error;
        }
      },

      logout: async () => {
          try {
            console.log('ðŸ‘‹ Logout initiated...');
            
            try {
              await authAPI.logout();
            } catch (error) {
              console.warn('Backend logout failed:', error);
            }
            
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            localStorage.removeItem('auth-storage');
            
            set({
              user: null,
              token: null,
              isAuthenticated: false,
              isLoading: false,
              error: null
            });
            
            console.log('âœ… Logout successful');
            toast.success('Logged out successfully');
            return true;
          } catch (error) {
            console.error('âŒ Logout error:', error);
            toast.error('Logout failed');
            throw error;
          }
        },

      fetchUser: async () => {
        set({ isLoading: true });
        try {
          const response = await authAPI.getMe();
          
          if (response.success && response.data) {
            set({
              user: response.data,
              isAuthenticated: true,
              isLoading: false
            });
            return response.data;
          }
        } catch (error) {
          console.error('Fetch user error:', error);
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          
          set({
            user: null,
            token: null,
            isAuthenticated: false,
            isLoading: false,
            error: 'Session expired. Please login again.'
          });
          
          throw error;
        }
      },

      updatePassword: async (currentPassword, newPassword, newPasswordConfirm) => {
        set({ isLoading: true, error: null });
        try {
          const response = await authAPI.updatePassword(
            currentPassword,
            newPassword,
            newPasswordConfirm
          );
          
          if (response.success) {
            set({ isLoading: false });
            toast.success('Password updated successfully');
            return response;
          }
        } catch (error) {
          const errorMessage = error.message || 'Failed to update password';
          set({
            error: errorMessage,
            isLoading: false
          });
          toast.error(errorMessage);
          throw error;
        }
      },

      initializeAuth: () => {
        const token = localStorage.getItem('token');
        const user = localStorage.getItem('user');

        if (token && user) {
          try {
            set({
              token,
              user: JSON.parse(user),
              isAuthenticated: true
            });
          } catch (error) {
            console.error('Failed to parse user data:', error);
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            set({
              token: null,
              user: null,
              isAuthenticated: false
            });
          }
        }
      },

      clearError: () => {
        set({ error: null });
      },

      clearAuth: () => {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        set({
          user: null,
          token: null,
          isAuthenticated: false,
          error: null,
          isLoading: false
        });
      }
    }),
    {
      name: 'auth-storage',
      partialize: (state) => ({
        user: state.user,
        token: state.token,
        isAuthenticated: state.isAuthenticated
      })
    }
  )
);

export default useAuthStore;